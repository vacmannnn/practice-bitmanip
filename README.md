# Practice shxadd
Данный код был написан в рамках работы над добавлением оптимизаций умножения в [llvm](https://github.com/vacmannnn/llvm-project/tree/RISCVMulOptimization). Было выдвинуто предположение, что 3 инструкции вида `shXadd` будут быстрее (эффективнее?), чем инструкция умножения. Программы из данного репозитория позволяют перебрать все возможные значения, которые можно получить из последовательности инструкций, и проанализировать их поддержку в компиляторе.

Команда `shXadd a0, a1, a2` в `a0` складывает результат `(a1 * (2 ^ x) + a2)`. Итоговая последовательность инструкций выглядит подобным образом:
```
shXadd a1, a0, a0
shYadd a1, a1, a1
shZadd a0, a1, a1
```
При `X=Y=Z=3` получается умножение регистра `a0` на 729. Значения `X,Y,Z` могут быть от 1 до 3. Помимо этого, вместо любого из `a1` может стоять и `a0`, то есть возможны подобные последовательности:
```
shXadd a1, a0, a0
shYadd a0, a1, a0
shZadd a0, a0, a1
```
Шаблоном в дальнейшем будет называться последовательность, в котором определены регистры, стоящие на месте `a1`.

Всего можно получить 1728 значений (27 вариантов значений `X,Y,Z` и 64 варианта регистров на месте `a1`), но не все из них осмысленны:
```
shXadd a1, a0, a0
shYadd a0, a0, a0
shZadd a0, a1, a1
```
Выражение выше можно заменить на:
```
shXadd a0, a0, a0
shZadd a0, a0, a0
```
Результат выражения при это не поменяется.

## Перебор возможных выражений
Для того, чтобы создать директории с шаблонами (patternX), состоящими из трех инструкций, необходимо запустить `creatingExpressions.py`:
```
python3 creatingExpressions.py
```
Каждая директория будет состоять из:
- Файл `forCpp.cpp` для генерации выражения на языке TableGen;
- Файл `pattern` с одним из шаблонов;
- Файл `pythonCode` с кодом, который создает тесты для всех возможных значений шаблона.

Далее необходимо в каждой директории создать тесты:
```
cd patternX
python3 pythonCode
```
После этого можно запустить утилиту [riscv-check](https://github.com/vacmannnn/riscv-check) в каждой директории (сконфигурировав ее соответственно).

Чтобы обработать результаты со всех шаблонов, необходимо запустить `pars.py` из директории `src`:
```
python3 pars.py
```
_При этом необходимо указать название текущего компиляторе в переменной `nameOfCompiler` внутри файла `pars.py`._
